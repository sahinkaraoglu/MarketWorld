@using MarketWorld.Web.Models
@model ProductDetailViewModel

@{
    ViewData["Title"] = Model.Name;
}

@section Styles {
    <link rel="stylesheet" href="~/css/Product/product-detail.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
}

@section Scripts {
    <script src="~/js/product-detail.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const cartToast = new bootstrap.Toast(document.getElementById('cartToast'));
            
            document.getElementById('addToCartBtn')?.addEventListener('click', function() {
                cartToast.show();
            });

            // Yıldız derecelendirme sistemi
            const ratingStars = document.querySelectorAll('.rating-stars .form-check-label');
            const ratingValue = document.getElementById('ratingValue');
            const commentForm = document.getElementById('commentForm');
            const ratingWarning = document.getElementById('ratingWarning');
            
            ratingStars.forEach(star => {
                star.addEventListener('click', function(e) {
                    e.preventDefault();
                    const value = this.getAttribute('data-rating');
                    ratingValue.value = value;
                    ratingWarning.style.display = 'none';
                    
                    // Seçilen yıldıza kadar olan tüm yıldızları doldur
                    ratingStars.forEach(s => {
                        const starValue = s.getAttribute('data-rating');
                        const starIcon = s.querySelector('i');
                        if (starValue <= value) {
                            starIcon.classList.remove('far');
                            starIcon.classList.add('fas');
                        } else {
                            starIcon.classList.remove('fas');
                            starIcon.classList.add('far');
                        }
                    });

                    // Radio butonunu seç
                    const radio = document.querySelector(`input[name="starRating"][value="${value}"]`);
                    if (radio) {
                        radio.checked = true;
                    }
                });
            });
            
            commentForm.addEventListener('submit', function(e) {
                if (!ratingValue.value) {
                    e.preventDefault();
                    ratingWarning.style.display = 'block';
                }
            });
        });
    </script>
    <script>
        // Textarea otomatik yükseklik ayarı
        const textarea = document.getElementById('commentText');
        if (textarea) {
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        }
    </script>
}

<div class="container py-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Ana Sayfa</a></li>
            <li class="breadcrumb-item"><a href="#">@Model.CategoryName</a></li>
            <li class="breadcrumb-item"><a href="/telefonlar">@Model.SubCategoryName</a></li>
            <li class="breadcrumb-item active">@Model.Name</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-6">
            <div class="product-images">
                <div class="main-image mb-3">
                    <img src="@Model.Images.FirstOrDefault()" class="img-fluid" alt="@Model.Name"
                         onerror="this.src='/img/default-product.jpg';" />
                </div>
                <div class="thumbnail-images">
                    @foreach (var image in Model.Images)
                    {
                        <div class="thumbnail">
                            <img src="@image" alt="@Model.Name" class="img-fluid"
                                 onerror="this.src='/img/default-product.jpg';" />
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Sağ Taraf - Ürün Bilgileri -->
        <div class="col-md-6">
            <div class="product-info">
                <h1 class="product-title text-start">
                    <span class="brand-name text-primary d-block">@Model.BrandName</span>
                    <span class="product-name">@Model.Name</span>
                    <p></p>
                    <span class="brand-name text-primary d-block"><p>Ürün Kodu:   @Model.ProductCode</p></span>
                </h1>

                <div class="product-description mb-4">
                    <p class="text-muted">@Model.Description</p>
                </div>

                <!-- Değerlendirme -->
                <div class="product-rating mb-4">
                    <div class="stars d-flex align-items-center">
                        @for (int i = 1; i <= 5; i++)
                        {
                            if (i <= Model.Rating)
                            {
                                <i class="fas fa-star text-warning"></i>
                            }
                            else if (i - Model.Rating < 1)
                            {
                                <i class="fas fa-star-half-alt text-warning"></i>
                            }
                            else
                            {
                                <i class="far fa-star text-warning"></i>
                            }
                        }
                        <span class="rating-value ms-2">@Model.Rating</span>
                        <span class="review-count text-muted ms-2">(@Model.ReviewCount Değerlendirme)</span>
                    </div>
                </div>

                <!-- Fiyat -->
                <div class="product-price mb-4">
                    @if (Model.HasDiscount && Model.DiscountPrice.HasValue)
                    {
                        <div class="d-flex align-items-center gap-3">
                            <div class="discounted-price h3 mb-0">@Model.DiscountPrice.Value.ToString("N2") TL</div>
                            <div class="original-price text-decoration-line-through text-muted">@Model.Price.ToString("N2") TL</div>
                            <div class="discount-badge bg-danger text-white px-2 py-1 rounded">
                                %@(((Model.Price - Model.DiscountPrice.Value) / Model.Price * 100).ToString("N0")) İndirim
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="current-price h3 mb-0">@Model.Price.ToString("N2") TL</div>
                    }
                </div>

                <!-- Kargo Bilgisi -->
                @if (Model.HasFreeShipping)
                {
                    <div class="shipping-info mb-4">
                        <div class="free-shipping d-flex align-items-center p-3 rounded border">
                            <i class="fas fa-truck-fast me-3 text-primary"></i>
                            <div>
                                <div class="shipping-title">BUGÜN KARGODA</div>
                                <div class="shipping-info-text">23:59'a kadar verdiğiniz siparişler aynı gün kargolanır</div>
                            </div>
                        </div>
                    </div>
                }

                <!-- Stok Bilgisi -->
                @if (Model.GetTotalStock() > 0)
                {
                    <div class="stock-info mb-4">
                        <div class="d-flex align-items-center text-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <span>Stokta @Model.GetTotalStock() adet mevcut</span>
                        </div>
                    </div>
                }
                else
                {
                    <div class="stock-info mb-4">
                        <div class="d-flex align-items-center text-danger">
                            <i class="fas fa-times-circle me-2"></i>
                            <span>Stokta ürün kalmadı</span>
                        </div>
                    </div>
                }

                <!-- Ürün Seçenekleri -->
                <div class="product-options mb-4">
                    <!-- Renk Seçenekleri -->
                    <div class="mb-4">
                        <div class="option-title mb-3">
                            <span class="fw-semibold">Renk:</span>
                            <span id="selectedColor" class="selected-value ms-2">@Model.ColorOptions.FirstOrDefault()?.Value</span>
                        </div>
                        <div class="color-options">
                            @foreach (var color in Model.ColorOptions)
                            {
                                <div class="color-option-wrapper">
                                    <input type="radio" 
                                           class="btn-check" 
                                           name="colorOption" 
                                           id="color_@color.Id" 
                                           value="@color.Value"
                                           @(color.IsSelected ? "checked" : "")
                                           @(color.Stock <= 0 ? "disabled" : "")>
                                    <label class="color-option @(color.Stock <= 0 ? "disabled" : "")" 
                                           for="color_@color.Id">
                                        <div class="d-flex flex-column align-items-center">
                                            <span class="color-name mb-1">@color.Value</span>
                                            @if (color.Stock <= 0)
                                            {
                                                <small class="text-danger">Stokta Yok</small>
                                            }
                                        </div>
                                    </label>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Hafıza Seçenekleri -->
                    <div class="mb-4">
                      @*   <div class="option-title mb-3">
                            <span class="fw-semibold">Dahili Hafıza:</span>
                            <span id="selectedMemory" class="selected-value ms-2">@Model.MemoryOptions.FirstOrDefault()?.Value</span>
                        </div> *@
                        <div class="memory-options">
                            @foreach (var memory in Model.MemoryOptions)
                            {
                                <div class="memory-option-wrapper">
                                    <input type="radio" 
                                           class="btn-check" 
                                           name="memoryOption" 
                                           id="memory_@memory.Id" 
                                           value="@memory.Value"
                                           @(memory.IsSelected ? "checked" : "")
                                           @(memory.Stock <= 0 ? "disabled" : "")>
                                    <label class="memory-option @(memory.Stock <= 0 ? "disabled" : "")" 
                                           for="memory_@memory.Id">
                                        <div class="d-flex flex-column align-items-center">
                                            <span class="memory-size">@memory.Value</span>
                                            @if (memory.Stock <= 0)
                                            {
                                                <small class="text-danger">Stokta Yok</small>
                                            }
                                        </div>
                                    </label>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Adet ve Sepete Ekle -->
                <div class="product-actions">
                    @if (Model.GetTotalStock() > 0)
                    {
                        <div class="quantity-selector mb-3">
                            <label class="form-label text-muted small">Adet</label>
                            <div class="input-group input-group-sm" style="width: 100px;">
                                <button class="btn btn-outline-secondary" type="button" id="decreaseQuantity">
                                    <i class="fas fa-minus small"></i>
                                </button>
                                <input type="number" class="form-control text-center" value="1" min="1" max="@Model.GetTotalStock()" id="quantity">
                                <button class="btn btn-outline-secondary" type="button" id="increaseQuantity">
                                    <i class="fas fa-plus small"></i>
                                </button>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button class="btn btn-primary flex-grow-1" id="addToCartBtn" data-product-id="@Model.Id">
                                <i class="fas fa-shopping-cart me-2"></i>
                                Sepete Ekle
                            </button>
                            <button class="btn btn-outline-secondary" title="Favorilere Ekle">
                                <i class="far fa-heart"></i>
                            </button>
                        </div>
                    }
                    else
                    {
                        <button class="btn btn-soft-danger w-100" disabled>
                            <i class="fas fa-times-circle me-2"></i>
                            Stokta Yok
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
    
    <!-- Yorumlar Bölümü -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card border-0 shadow-sm rounded-3">
                <div class="card-header bg-transparent py-3 border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Ürün Değerlendirmeleri (@Model.ReviewCount)</h5>
                        <div class="d-flex align-items-center">
                            <span class="h5 mb-0 me-2">@Model.Rating.ToString("0.0")</span>
                            <div class="stars">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    if (i <= Math.Floor(Model.Rating))
                                    {
                                        <i class="fas fa-star text-warning"></i>
                                    }
                                    else if (i - Model.Rating <= 0.5 && i - Model.Rating > 0)
                                    {
                                        <i class="fas fa-star-half-alt text-warning"></i>
                                    }
                                    else
                                    {
                                        <i class="far fa-star text-warning"></i>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4">
                    <!-- Yorum Ekleme -->
                    <div class="comment-form mb-4 p-4">
                        <form asp-action="AddComment" asp-controller="Product" method="post" id="commentForm">
                            <input type="hidden" name="ProductId" value="@Model.Id" />
                            <input type="hidden" id="ratingValue" name="Rating" value="" />
                            
                            <div class="d-flex gap-3 align-items-center mb-3">
                                <div class="flex-grow-1">
                                    <input type="text" class="form-control" id="userName" name="UserName" placeholder="Adınız" required>
                                </div>
                                <div class="rating-stars">
                                    @for (int i = 5; i >= 1; i--)
                                    {
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input rating-input" 
                                                   type="radio" 
                                                   name="starRating" 
                                                   id="star@(i)" 
                                                   value="@i">
                                            <label class="form-check-label" 
                                                   for="star@(i)" 
                                                   data-rating="@i">
                                                <i class="far fa-star text-warning"></i>
                                            </label>
                                        </div>
                                    }
                                </div>
                            </div>
                            
                            <div class="d-flex gap-3">
                                <div class="flex-grow-1">
                                    <textarea class="form-control" id="commentText" name="Text" rows="1" placeholder="Ürün hakkındaki görüşleriniz..." required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Gönder</button>
                            </div>
                            <div id="ratingWarning" class="text-danger mt-2" style="display: none;">Lütfen bir değerlendirme puanı seçiniz!</div>
                        </form>
                    </div>
                    
                    <!-- Mevcut Yorumlar -->
                    @if (Model.Comments != null && Model.Comments.Any())
                    {
                        <div class="comments-list">
                            @foreach (var comment in Model.Comments.OrderByDescending(c => c.CreatedDate))
                            {
                                <div class="comment-item py-2">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="d-flex gap-2">
                                            <div class="user-icon">
                                                <i class="fas fa-user-circle"></i>
                                            </div>
                                            <div>
                                                <div class="fw-medium">@comment.UserName</div>
                                                <div class="text-muted small">@(comment.CreatedDate?.ToString("dd/MM/yyyy"))</div>
                                                <div class="comment-text mt-1">@comment.Text</div>
                                            </div>
                                        </div>
                                        <div class="comment-rating">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                <i class="@(i <= comment.Rating ? "fas" : "far") fa-star text-warning small"></i>
                                            }
                                        </div>
                                    </div>
                                </div>
                                @if (comment != Model.Comments.OrderByDescending(c => c.CreatedDate).Last())
                                {
                                    <hr class="my-2" />
                                }
                            }
                        </div>
                    }
                    else
                    {
                        <div class="no-comments text-center py-3">
                            <i class="far fa-comment-dots fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-0">Bu ürün için henüz yorum bulunmuyor. İlk yorumu siz yapın!</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.option-title {
    font-size: 1rem;
}

.selected-value {
    color: #0d6efd;
    font-weight: 500;
}

.color-options, .memory-options {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.color-option, .memory-option {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 100px;
    padding: 0.75rem 1rem;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    background-color: white;
}

.color-option:hover:not(.disabled),
.memory-option:hover:not(.disabled) {
    border-color: #0d6efd;
    background-color: #f8f9fa;
}

.color-option.disabled,
.memory-option.disabled {
    opacity: 0.6;
    cursor: not-allowed;
    background-color: #f8f9fa;
}

.btn-check:checked + .color-option,
.btn-check:checked + .memory-option {
    border-color: #0d6efd;
    background-color: #e7f1ff;
}

.color-name, .memory-size {
    font-weight: 500;
    font-size: 0.9rem;
}

small.text-danger {
    font-size: 0.75rem;
    margin-top: 0.25rem;
}

.free-shipping {
    background-color: #f8f9fa;
    transition: all 0.2s ease;
}

.free-shipping:hover {
    background-color: #fff;
    border-color: #0d6efd !important;
}

.free-shipping i {
    font-size: 1.5rem;
}

.shipping-title {
    font-size: 0.8rem;
    font-weight: 600;
    color: #0d6efd;
    letter-spacing: 0.5px;
}

.shipping-info-text {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 2px;
}

.comment-form {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.04);
    transition: all 0.3s ease;
}

.comment-form:hover {
    box-shadow: 0 4px 20px rgba(0,0,0,0.06);
}

.comment-form .form-control {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 0.625rem 1rem;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    background: #fff;
}

.comment-form .form-control:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}

.comment-form .form-control::placeholder {
    color: #adb5bd;
    font-size: 0.95rem;
}

.rating-stars {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px;
    border-radius: 8px;
}

.rating-stars .form-check {
    margin: 0;
    padding: 0;
}

.rating-stars .form-check-input {
    display: none;
}

.rating-stars .form-check-label {
    cursor: pointer;
    padding: 4px;
    transition: transform 0.2s ease;
}

.rating-stars .form-check-label:hover {
    transform: scale(1.2);
}

.rating-stars .form-check-label i {
    font-size: 1.25rem;
    color: #ffd700;
}

.rating-stars .form-check-label:hover i {
    color: #ffd700;
}

.btn-primary {
    padding: 0.625rem 1.5rem;
    font-weight: 500;
    border-radius: 8px;
    background: #0d6efd;
    border: none;
    transition: all 0.2s ease;
}

.btn-primary:hover {
    background: #0b5ed7;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(13,110,253,0.2);
}

textarea {
    resize: none;
    overflow: hidden;
    min-height: 42px;
}

.comment-item {
    font-size: 0.9rem;
    transition: all 0.2s ease;
    border-radius: 6px;
    padding: 12px;
}

.comment-item:hover {
    background-color: #f8f9fa;
}

.comment-item .user-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #e9ecef;
    border-radius: 50%;
    color: #6c757d;
}

.comment-text {
    font-size: 0.875rem;
    line-height: 1.5;
    color: #495057;
}

.no-comments {
    color: #6c757d;
    font-size: 0.9rem;
    padding: 2rem 0;
}

.no-comments i {
    opacity: 0.5;
    margin-bottom: 1rem;
}

.stars i {
    font-size: 0.9rem;
    transition: color 0.2s ease;
}

.stars i:hover {
    color: #ffc107;
}

hr {
    opacity: 0.1;
    margin: 0.75rem 0;
}

.comment-rating {
    background: #fff;
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #e9ecef;
}
</style>

<!-- Toast Bildirimi -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="cartToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-check-circle text-success me-2"></i>
            <strong class="me-auto">Başarılı</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            Ürün sepete eklendi!
        </div>
    </div>
</div> 