@model IEnumerable<MarketWorld.Web.Models.UserViewModel>
@{
    ViewData["Title"] = "Kullanıcı Yönetimi";
}

<div class="users-container">
    <div class="users-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="users-title">Kullanıcı Yönetimi</h1>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                    <i class="bi bi-person-plus"></i> Yeni Kullanıcı Ekle
                </button>
            </div>
        </div>
    </div>

    <div class="container users-content">
        <div class="card mb-4">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="mb-0"><i class="bi bi-people me-2"></i>Tüm Kullanıcılar</h5>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" id="userSearchInput" class="form-control" placeholder="Kullanıcı ara...">
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover user-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Kullanıcı Adı</th>
                                <th>Email</th>
                                <th>Ad</th>
                                <th>Soyad</th>
                                <th>Rol</th>
                                <th>Kayıt Tarihi</th>
                                <th>Durum</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model != null && Model.Any())
                            {
                                foreach (var user in Model)
                                {
                                    <tr>
                                        <td>@user.Id</td>
                                        <td>@user.Username</td>
                                        <td>@user.Email</td>
                                        <td>@user.FirstName</td>
                                        <td>@user.LastName</td>
                                        <td>
                                            <span class="badge bg-@(user.Role == "Admin" ? "danger" : user.Role == "Moderator" ? "warning" : "info")">
                                                @user.Role
                                            </span>
                                        </td>
                                        <td>@user.RegistrationDate?.ToShortDateString()</td>
                                        <td>
                                            <span class="badge bg-@(user.IsActive ? "success" : "secondary")">
                                                @(user.IsActive ? "Aktif" : "Pasif")
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                                        data-bs-toggle="modal" data-bs-target="#editUserModal" 
                                                        data-user-id="@user.Id">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        data-bs-toggle="modal" data-bs-target="#deleteUserModal" 
                                                        data-user-id="@user.Id">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="9" class="text-center">Henüz kayıtlı kullanıcı bulunmamaktadır.</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <nav aria-label="Kullanıcı sayfaları">
                    <ul class="pagination justify-content-center">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Önceki</a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#">Sonraki</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon bg-primary">
                                <i class="bi bi-people-fill"></i>
                            </div>
                            <div class="ms-3">
                                <h6 class="card-subtitle mb-1">Toplam Kullanıcı</h6>
                                <h2 class="card-title mb-0">@ViewBag.TotalUsersCount</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon bg-success">
                                <i class="bi bi-person-check-fill"></i>
                            </div>
                            <div class="ms-3">
                                <h6 class="card-subtitle mb-1">Aktif Kullanıcılar</h6>
                                <h2 class="card-title mb-0">@ViewBag.ActiveUsersCount</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon bg-warning">
                                <i class="bi bi-person-plus-fill"></i>
                            </div>
                            <div class="ms-3">
                                <h6 class="card-subtitle mb-1">Yeni Kayıtlar (Bu Ay)</h6>
                                <h2 class="card-title mb-0">@ViewBag.NewUsersCount</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Yeni Kullanıcı Ekleme Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">Yeni Kullanıcı Ekle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="username" class="form-label">Kullanıcı Adı</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="firstName" class="form-label">Ad</label>
                            <input type="text" class="form-control" id="firstName">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lastName" class="form-label">Soyad</label>
                            <input type="text" class="form-control" id="lastName">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="password" class="form-label">Şifre</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="confirmPassword" class="form-label">Şifre Tekrar</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="role" class="form-label">Rol</label>
                            <select class="form-select" id="role">
                                <option value="User">Kullanıcı</option>
                                <option value="Admin">Yönetici</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="isActive" class="form-label">Durum</label>
                            <select class="form-select" id="isActive">
                                <option value="true">Aktif</option>
                                <option value="false">Pasif</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" id="saveNewUser">Kaydet</button>
            </div>
        </div>
    </div>
</div>

<!-- Kullanıcı Düzenleme Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Kullanıcı Düzenle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editUsername" class="form-label">Kullanıcı Adı</label>
                            <input type="text" class="form-control" id="editUsername" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="editEmail" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editFirstName" class="form-label">Ad</label>
                            <input type="text" class="form-control" id="editFirstName">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editLastName" class="form-label">Soyad</label>
                            <input type="text" class="form-control" id="editLastName">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editPassword" class="form-label">Yeni Şifre (Boş bırakılabilir)</label>
                            <input type="password" class="form-control" id="editPassword">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editRole" class="form-label">Rol</label>
                            <select class="form-select" id="editRole">
                                <option value="User">Kullanıcı</option>
                                <option value="Admin">Yönetici</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editStatus" class="form-label">Durum</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="editStatus">
                            <label class="form-check-label" for="editStatus">Aktif</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" id="updateUser">Güncelle</button>
            </div>
        </div>
    </div>
</div>

<!-- Kullanıcı Silme Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteUserModalLabel">Kullanıcıyı Sil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body">
                <p>Bu kullanıcıyı silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.</p>
                <input type="hidden" id="deleteUserId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteUser">Sil</button>
            </div>
        </div>
    </div>
</div>

<style>
    .users-container {
        background-color: #f8f9fa;
        min-height: 100vh;
    }
    
    .users-header {
        background: linear-gradient(135deg, #2c3e50, #4ca1af);
        color: white;
        padding: 20px 0;
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .users-title {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 0;
    }
    
    .users-content {
        padding-bottom: 30px;
    }
    
    .user-table th {
        font-weight: 600;
        background-color: #f8f9fa;
    }
    
    .user-table td, .user-table th {
        vertical-align: middle;
    }
    
    .stat-card {
        border: none;
        box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
        margin-bottom: 15px;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0,0,0,0.1);
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
    }
    
    .bg-primary {
        background-color: #4e73df !important;
    }
    
    .bg-success {
        background-color: #1cc88a !important;
    }
    
    .bg-warning {
        background-color: #f6c23e !important;
    }
</style>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Kullanıcı arama fonksiyonu
            $("#userSearchInput").on("keyup", function() {
                var value = $(this).val().toLowerCase();
                $(".user-table tbody tr").filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });
            
            // Kullanıcı düzenleme modalını doldur
            $('#editUserModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var userId = button.data('user-id');
                var modal = $(this);
                
                // AJAX isteği ile kullanıcı bilgilerini getir
                $.ajax({
                    url: '/Panel/GetUser/' + userId,
                    type: 'GET',
                    success: function(data) {
                        modal.find('#editUserId').val(data.id);
                        modal.find('#editUsername').val(data.username);
                        modal.find('#editEmail').val(data.email);
                        modal.find('#editFirstName').val(data.firstName);
                        modal.find('#editLastName').val(data.lastName);
                        modal.find('#editRole').val(data.role);
                        modal.find('#editStatus').prop('checked', data.isActive);
                    }
                });
            });
            
            // Kullanıcı silme modalını doldur
            $('#deleteUserModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var userId = button.data('user-id');
                var modal = $(this);
                modal.find('#deleteUserId').val(userId);
            });
            
            // Yeni kullanıcı kaydetme
            $('#saveNewUser').click(function() {
                var formData = {
                    username: $('#username').val(),
                    email: $('#email').val(),
                    firstName: $('#firstName').val(),
                    lastName: $('#lastName').val(),
                    password: $('#password').val(),
                    confirmPassword: $('#confirmPassword').val(),
                    role: $('#role').val(),
                    isActive: $('#isActive').val() === 'true'
                };
                
                if(formData.password !== formData.confirmPassword) {
                    alert('Şifreler eşleşmiyor!');
                    return;
                }
                
                $.ajax({
                    url: '/Panel/AddUser',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        if(response.success) {
                            $('#addUserModal').modal('hide');
                            location.reload();
                        } else {
                            alert(response.message);
                        }
                    }
                });
            });
            
            // Kullanıcı güncelleme
            $('#updateUser').click(function() {
                var formData = {
                    id: $('#editUserId').val(),
                    username: $('#editUsername').val(),
                    email: $('#editEmail').val(),
                    firstName: $('#editFirstName').val(),
                    lastName: $('#editLastName').val(),
                    password: $('#editPassword').val(),
                    confirmPassword: $('#editPassword').val(),
                    role: $('#editRole').val(),
                    isActive: $('#editStatus').is(':checked')
                };
                
                $.ajax({
                    url: '/Panel/UpdateUser',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        if(response.success) {
                            $('#editUserModal').modal('hide');
                            location.reload();
                        } else {
                            alert(response.message);
                        }
                    }
                });
            });
            
            // Kullanıcı silme
            $('#confirmDeleteUser').click(function() {
                var userId = $('#deleteUserId').val();
                
                $.ajax({
                    url: '/Panel/DeleteUser/' + userId,
                    type: 'POST',
                    success: function(response) {
                        if(response.success) {
                            $('#deleteUserModal').modal('hide');
                            location.reload();
                        } else {
                            alert(response.message);
                        }
                    }
                });
            });
        });
    </script>
}
